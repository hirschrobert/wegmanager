name: WEG Manager debian build test
on:
  push:
    branches:
      - main
      - '**dev**'
  pull_request:
    branches:
      - main
      - '**dev**'

jobs:
  debian-build-test:
    runs-on: ubuntu-20.04
    timeout-minutes: 10
    name: Build Package
    steps:
    - run: echo "ðŸŽ‰ Job triggered by ${{ github.event_name }} event, runs on a ${{ runner.os }} server."
    - name: Check out repository code
      uses: actions/checkout@v2
    - run: echo "ðŸ’¡ Branch ${{ github.ref }} of ${{ github.repository }} repository has been cloned to the runner."
    - name: Install Ubuntu build depenencies
      id: ubuntu-dependencies
      run: |
        sudo add-apt-repository ppa:jyrki-pulliainen/dh-virtualenv
        sudo add-apt-repository ppa:deadsnakes/ppa
        sudo apt-get install -y devscripts dh-virtualenv debhelper build-essential python3-virtualenv python3.10 python3.10-tk python3.10-distutils dh-python python3-all
    - name: Install Python depenencies
      id: python-dependencies
      run: |
        sudo apt-get install -y libjpeg-dev libtiff5-dev libjpeg8-dev libopenjp2-7-dev zlib1g-dev libfreetype6-dev liblcms2-dev libwebp-dev tcl8.6-dev tk8.6-dev libharfbuzz-dev libfribidi-dev libxcb1-dev libgraphviz-dev graphviz
        cd /usr/bin/
        sudo rm python3
        sudo rm python
        sudo ln -s python3.10 python3
        sudo ln -s python3.10 python
        echo -e "default-version = python3.10\nsupported-versions = python3.10\nold-versions = python3.1, python3.2, python3.3, python3.4, python3.5, python3.6, python3.7, python3.8\nunsupported-versions = python3.1, python3.2, python3.3, python3.4, python3.5, python3.6, python3.7, python3.8" > /usr/share/python3/debian_defaults
        curl https://raw.githubusercontent.com/pypa/pipenv/master/get-pipenv.py | python
    - name: Install dependencies from project Pipfile
      id: project-dependencies
      run: |
        pipenv --python 3.10
        pipenv install --dev
    - name: pylint
      run: pipenv run pylint ./wegmanager/  
    - name: Run build in pipenv
      run: |
        echo "DEB_BUILD_OPTIONS=nostrip" > build.env
        PIPENV_DOTENV_LOCATION=build.env pipenv run debuild -b -us -uc
